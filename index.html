<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestor de Eventos</title>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: #1a1a2e;
color: #eee;
padding: 20px;
}

.header {
background: #16213e;
padding: 20px;
border-radius: 10px;
margin-bottom: 20px;
display: grid;
grid-template-columns: 1fr auto;
gap: 15px;
align-items: center;
}

.search-container {
position: relative;
}

.search-input {
width: 100%;
padding: 12px 40px 12px 15px;
border: 2px solid #0f3460;
border-radius: 8px;
background: #0f3460;
color: #eee;
font-size: 16px;
}

.search-input:focus {
outline: none;
border-color: #53a8ff;
}

.clear-search {
position: absolute;
right: 10px;
top: 50%;
transform: translateY(-50%);
background: #ff6b6b;
border: none;
color: white;
width: 25px;
height: 25px;
border-radius: 50%;
cursor: pointer;
display: none;
}

.clear-search.visible {
display: block;
}

.search-dropdown {
position: absolute;
top: 100%;
left: 0;
right: 0;
background: #0f3460;
border: 2px solid #53a8ff;
border-radius: 8px;
margin-top: 5px;
max-height: 300px;
overflow-y: auto;
z-index: 1000;
display: none;
}

.search-dropdown.visible {
display: block;
}

.search-item {
padding: 10px 15px;
cursor: pointer;
border-bottom: 1px solid #16213e;
}

.search-item:hover, .search-item.selected {
background: #53a8ff;
}

.button-group {
display: flex;
gap: 10px;
flex-wrap: nowrap;
}

.btn {
padding: 12px 24px;
border: none;
border-radius: 8px;
cursor: pointer;
font-size: 14px;
font-weight: bold;
transition: all 0.3s;
white-space: nowrap;
}

.btn-save {
background: #4caf50;
color: white;
}

.btn-save.changed {
background: #ff4444;
animation: pulse 1s infinite;
}

@keyframes pulse {
0%, 100% { opacity: 1; }
50% { opacity: 0.5; }
}

.btn-add {
background: #2196f3;
color: white;
}

.btn-add-text {
background: #ff9800;
color: white;
}

.btn-delete {
background: #ff4444;
color: white;
}

.btn-duplicate {
background: #9c27b0;
color: white;
}

.btn:hover {
transform: translateY(-2px);
box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

.columns {
display: grid;
grid-template-columns: repeat(5, 1fr);
gap: 20px;
margin-bottom: 20px;
height: 280px;
}

.card {
background: #16213e;
border-radius: 10px;
padding: 15px;
display: flex;
flex-direction: column;
}

.card-title {
font-size: 20px;
font-weight: bold;
margin-bottom: 15px;
text-align: center;
}

.neon-red {
color: #ff0000;
text-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000, 0 0 30px #ff0000;
}

.neon-blue {
color: #00d4ff;
text-shadow: 0 0 10px #00d4ff, 0 0 20px #00d4ff, 0 0 30px #00d4ff;
}

.countdown {
font-size: 36px;
text-align: center;
margin: 10px 0;
font-weight: bold;
flex: 1;
display: flex;
align-items: center;
justify-content: center;
}

.progress-bar {
width: 100%;
height: 15px;
background: #0f3460;
border-radius: 10px;
overflow: hidden;
margin-top: 10px;
}

.progress-fill {
height: 100%;
background: linear-gradient(90deg, #ff0000, #ff6b6b);
transition: width 1s;
}

.clock {
font-size: 42px;
text-align: center;
margin: 10px 0;
font-weight: bold;
font-family: 'Courier New', monospace;
flex: 1;
display: flex;
align-items: center;
justify-content: center;
}

.date {
text-align: center;
font-size: 16px;
margin: 8px 0;
cursor: pointer;
padding: 8px;
border-radius: 5px;
transition: background 0.3s;
}

.date:hover {
background: #0f3460;
}

.weather-widget {
flex: 1;
display: flex;
align-items: center;
justify-content: center;
}

.iframe-double {
grid-column: span 2;
}

.iframe-container {
width: 100%;
height: 100%;
background: #0f3460;
border-radius: 10px;
padding: 10px;
display: flex;
flex-direction: column;
}

.iframe-nav {
display: flex;
gap: 8px;
margin-bottom: 10px;
}

.iframe-nav-btn {
background: #2196f3;
border: none;
color: white;
padding: 8px 16px;
border-radius: 5px;
cursor: pointer;
font-weight: bold;
transition: all 0.3s;
}

.iframe-nav-btn:hover {
background: #1976d2;
}

.iframe-nav-btn:disabled {
background: #555;
cursor: not-allowed;
}

.iframe-wrapper {
flex: 1;
position: relative;
background: white;
border-radius: 5px;
overflow: hidden;
}

.iframe-wrapper iframe {
width: 375px;
height: 100%;
border: none;
transform-origin: 0 0;
}

.timeline {
background: #16213e;
padding: 20px;
border-radius: 10px;
position: relative;
user-select: none;
}

.timeline-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
flex-wrap: wrap;
gap: 10px;
}

.timeline-nav {
display: flex;
gap: 10px;
flex-wrap: wrap;
}

.timeline-nav-btn {
background: #0f3460;
border: none;
color: #fff;
padding: 12px 20px;
border-radius: 8px;
cursor: pointer;
font-weight: bold;
transition: all 0.3s;
font-size: 14px;
}

.timeline-nav-btn:hover {
background: #53a8ff;
transform: translateY(-2px);
}

.timeline-days-container {
overflow: hidden;
position: relative;
}

.timeline-days {
display: flex;
gap: 15px;
transition: transform 0.3s ease;
cursor: grab;
}

.timeline-days.dragging {
cursor: grabbing;
transition: none;
}

.timeline-day {
flex: 0 0 220px;
min-width: 220px;
background: #0f3460;
border-radius: 10px;
padding: 20px;
transition: all 0.3s;
box-shadow: 0 4px 6px rgba(0,0,0,0.3);
}

.timeline-day:hover {
transform: translateY(-5px);
box-shadow: 0 8px 12px rgba(0,0,0,0.4);
}

.timeline-day.today {
border: 3px solid #2196f3;
background: #1a3a5c;
box-shadow: 0 0 20px rgba(33, 150, 243, 0.5);
}

.timeline-day.future {
background: #1a4d2e;
}

.timeline-day.past {
background: #2d3a2e;
opacity: 0.8;
}

.timeline-day.weekend, .timeline-day.holiday {
background: #4d1a1a;
}

.timeline-day.past.weekend, .timeline-day.past.holiday {
background: #3a1a1a;
opacity: 0.7;
}

.timeline-date {
font-size: 20px;
font-weight: bold;
margin-bottom: 15px;
text-align: center;
border-bottom: 2px solid rgba(255,255,255,0.2);
padding-bottom: 10px;
}

.timeline-events {
margin-top: 15px;
max-height: 300px;
overflow-y: auto;
}

.timeline-event {
background: #16213e;
padding: 12px;
margin: 8px 0;
border-radius: 8px;
font-size: 13px;
cursor: pointer;
transition: all 0.3s;
border-left: 4px solid #53a8ff;
}

.timeline-event:hover {
background: #1e2d4d;
transform: translateX(5px);
box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.timeline-event-time {
font-weight: bold;
color: #53a8ff;
font-size: 12px;
margin-bottom: 5px;
}

.modal {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0,0,0,0.8);
z-index: 2000;
justify-content: center;
align-items: center;
}

.modal.visible {
display: flex;
}

.modal-content {
background: #16213e;
padding: 30px;
border-radius: 10px;
max-width: 800px;
width: 90%;
max-height: 90vh;
overflow-y: auto;
}

.modal-header {
font-size: 24px;
font-weight: bold;
margin-bottom: 20px;
}

.modal-close {
float: right;
font-size: 28px;
cursor: pointer;
color: #ff6b6b;
}

.form-group {
margin-bottom: 15px;
}

.form-label {
display: block;
margin-bottom: 5px;
font-weight: bold;
}

.form-input, .form-textarea {
width: 100%;
padding: 10px;
border: 2px solid #0f3460;
border-radius: 5px;
background: #0f3460;
color: #eee;
font-size: 14px;
}

.form-textarea {
min-height: 200px;
font-family: monospace;
}

.form-input:focus, .form-textarea:focus {
outline: none;
border-color: #53a8ff;
}

.modal-buttons {
display: flex;
gap: 10px;
margin-top: 20px;
flex-wrap: wrap;
}

.event-summary {
background: #0f3460;
padding: 15px;
border-radius: 5px;
margin: 10px 0;
}

.event-summary-item {
padding: 8px;
margin: 5px 0;
background: #16213e;
border-radius: 5px;
}

.calendar-view {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0,0,0,0.95);
z-index: 2000;
padding: 20px;
overflow-y: auto;
}

.calendar-view.visible {
display: block;
}

.calendar-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 20px;
flex-wrap: wrap;
gap: 10px;
}

.calendar-close {
font-size: 32px;
cursor: pointer;
color: #ff6b6b;
}

.calendar-months {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
gap: 20px;
}

.calendar-month {
background: #16213e;
padding: 15px;
border-radius: 10px;
}

.calendar-month-title {
font-size: 20px;
font-weight: bold;
text-align: center;
margin-bottom: 10px;
}

.calendar-grid {
display: grid;
grid-template-columns: repeat(7, 1fr);
gap: 5px;
}

.calendar-day-header {
text-align: center;
font-weight: bold;
padding: 5px;
font-size: 12px;
}

.calendar-day {
aspect-ratio: 1;
border: 1px solid #0f3460;
border-radius: 5px;
padding: 5px;
text-align: center;
cursor: pointer;
position: relative;
display: flex;
flex-direction: column;
justify-content: space-between;
transition: all 0.3s;
}

.calendar-day:hover {
background: #0f3460;
transform: scale(1.05);
}

.calendar-day.today {
background: #1a3a5c;
border-color: #2196f3;
box-shadow: 0 0 10px rgba(33, 150, 243, 0.5);
}

.calendar-day.future {
background: #1a3a2e;
}

.calendar-day.past {
background: #2a2a2a;
opacity: 0.6;
}

.calendar-day.weekend, .calendar-day.holiday {
background: #3a1a1a;
}

.calendar-day.past.weekend, .calendar-day.past.holiday {
background: #2a1a1a;
}

.calendar-day.other-month {
opacity: 0.3;
}

.calendar-day-dots {
display: flex;
gap: 2px;
justify-content: center;
flex-wrap: wrap;
}

.calendar-day-dot {
width: 4px;
height: 4px;
background: #53a8ff;
border-radius: 50%;
}

.calendar-sidebar {
position: fixed;
right: 0;
top: 0;
width: 350px;
height: 100%;
background: #16213e;
padding: 20px;
transform: translateX(100%);
transition: transform 0.3s;
z-index: 2001;
overflow-y: auto;
box-shadow: -5px 0 15px rgba(0,0,0,0.5);
}

.calendar-sidebar.visible {
transform: translateX(0);
}

.sidebar-close {
float: right;
font-size: 24px;
cursor: pointer;
color: #ff6b6b;
}

.sidebar-date {
font-size: 20px;
font-weight: bold;
margin-bottom: 20px;
}

.sidebar-event {
background: #0f3460;
padding: 10px;
margin: 10px 0;
border-radius: 5px;
cursor: pointer;
transition: all 0.3s;
border-left: 4px solid #53a8ff;
}

.sidebar-event:hover {
background: #1a4d7a;
transform: translateX(5px);
}

.sidebar-add-btn {
width: 100%;
margin-top: 15px;
}

@media (max-width: 1400px) {
.columns {
    grid-template-columns: repeat(3, 1fr);
    height: auto;
}
.iframe-double {
    grid-column: span 3;
    height: 400px;
}
.header {
    grid-template-columns: 1fr;
}
.button-group {
    justify-content: center;
}
}

@media (max-width: 900px) {
.columns {
    grid-template-columns: 1fr;
}
.iframe-double {
    grid-column: span 1;
}
.calendar-sidebar {
    width: 100%;
}
.timeline-day {
    flex: 0 0 180px;
    min-width: 180px;
}
}
</style>
</head>
<body>
<div class="header">
<div class="search-container">
<input type="text" class="search-input" id="searchInput" placeholder="Buscar eventos...">
<button class="clear-search" id="clearSearch">✕</button>
<div class="search-dropdown" id="searchDropdown"></div>
</div>
<div class="button-group">
<button class="btn btn-save" id="btnSave">Guardar Calendario</button>
<button class="btn btn-add" id="btnAdd">Añadir Evento</button>
<button class="btn btn-add-text" id="btnAddText">Añadir Eventos (texto)</button>
</div>
</div>

<div class="columns">
<div class="card">
<div class="card-title" id="morningTitle">MAÑANAS</div>
<div class="countdown" id="morningCountdown">--:--:--</div>
<div id="morningProgress"></div>
</div>

<div class="card">
<div class="card-title" id="afternoonTitle">TARDES</div>
<div class="countdown" id="afternoonCountdown">--:--:--</div>
<div id="afternoonProgress"></div>
</div>

<div class="card">
<div class="card-title" style="cursor: pointer;" id="todayTitle">HOY</div>
<div class="clock neon-blue" id="clock">00:00:00</div>
<div class="date" id="dateDisplay">Fecha</div>
<div class="weather-widget">
    <div id="mrwidb5079e7663ded13edcc5ad94b1da0b5a" style="cursor: pointer;" onclick="window.open('https://www.tiempo.com/valladolid.htm', '_blank')">
        <script type="text/javascript" async src="https://api.meteored.com/widget/loader/b5079e7663ded13edcc5ad94b1da0b5a"></script>
    </div>
</div>
</div>

<div class="card iframe-double">
<div class="iframe-container">
    <div class="iframe-nav">
        <button class="iframe-nav-btn" id="iframeBack" disabled>◄ Atrás</button>
        <button class="iframe-nav-btn" id="iframeForward" disabled>Adelante ►</button>
        <button class="iframe-nav-btn" id="iframeHome">🏠 Home</button>
    </div>
    <div class="iframe-wrapper">
        <iframe id="educaFrame" src="https://www.educa.jcyl.es/profesorado/es/formacion-profesorado/actualidad-formacion-profesorado" scrolling="yes"></iframe>
    </div>
</div>
</div>
</div>

<div class="timeline">
<div class="timeline-header">
<div class="timeline-nav">
    <button class="timeline-nav-btn" onclick="moveTimeline(-7)">◄◄ -7 días</button>
    <button class="timeline-nav-btn" onclick="moveTimeline(-1)">◄ -1 día</button>
</div>
<button class="timeline-nav-btn" onclick="resetTimeline()">HOY</button>
<div class="timeline-nav">
    <button class="timeline-nav-btn" onclick="moveTimeline(1)">+1 día ►</button>
    <button class="timeline-nav-btn" onclick="moveTimeline(7)">+7 días ►►</button>
</div>
</div>
<div class="timeline-days-container">
<div class="timeline-days" id="timelineDays"></div>
</div>
</div>

<!-- Modal Añadir/Editar Evento -->
<div class="modal" id="modalEvent">
<div class="modal-content">
<span class="modal-close" onclick="closeModal('modalEvent')">&times;</span>
<div class="modal-header" id="modalEventHeader">Añadir Evento</div>
<form id="eventForm">
    <div class="form-group">
        <label class="form-label">Fecha:</label>
        <input type="date" class="form-input" id="eventDate" required>
    </div>
    <div class="form-group">
        <label class="form-label">Hora de inicio (dejar vacío para "TODO EL DÍA"):</label>
        <input type="time" class="form-input" id="eventTimeStart">
    </div>
    <div class="form-group">
        <label class="form-label">Hora de fin:</label>
        <input type="time" class="form-input" id="eventTimeEnd">
    </div>
    <div class="form-group">
        <label class="form-label">Descripción del evento:</label>
        <input type="text" class="form-input" id="eventDescription" required>
    </div>
    <div class="modal-buttons">
        <button type="submit" class="btn btn-add" id="btnSaveEvent">Guardar</button>
        <button type="button" class="btn btn-duplicate" id="btnDuplicateEvent" style="display: none;" onclick="duplicateEvent()">Duplicar</button>
        <button type="button" class="btn btn-delete" id="btnDeleteEvent" style="display: none;" onclick="deleteEvent()">Eliminar</button>
        <button type="button" class="btn" style="background: #666;" onclick="closeModal('modalEvent')">Cancelar</button>
    </div>
</form>
</div>
</div>

<!-- Modal Añadir Eventos desde Texto -->
<div class="modal" id="modalAddText">
<div class="modal-content">
<span class="modal-close" onclick="closeModal('modalAddText')">&times;</span>
<div class="modal-header">Añadir Eventos desde Texto</div>
<div class="form-group">
    <label class="form-label">Pegar texto con eventos:</label>
    <textarea class="form-textarea" id="eventsText" placeholder="█ 2025/11/25 ___________ +[evento] descripción&#10;! 2025/11/26 16:00-18:00 +evento descripción"></textarea>
</div>
<div class="modal-buttons">
    <button class="btn btn-add" onclick="parseEventsText()">Procesar</button>
    <button class="btn" style="background: #666;" onclick="closeModal('modalAddText')">Cancelar</button>
</div>
<div id="eventsSummary"></div>
</div>
</div>

<!-- Vista Calendario -->
<div class="calendar-view" id="calendarView">
<div class="calendar-header">
<h1>Calendario Anual 2025</h1>
<div>
    <button class="btn btn-add" onclick="openAddEventModalFromCalendar()">+ Añadir Evento</button>
    <span class="calendar-close" onclick="closeCalendarView()">&times;</span>
</div>
</div>
<div class="calendar-months" id="calendarMonths"></div>
</div>

<!-- Sidebar Eventos del Día -->
<div class="calendar-sidebar" id="calendarSidebar">
<span class="sidebar-close" onclick="closeSidebar()">&times;</span>
<div class="sidebar-date" id="sidebarDate"></div>
<button class="btn btn-add sidebar-add-btn" onclick="addEventToSidebarDate()">+ Añadir evento a este día</button>
<div id="sidebarEvents"></div>
</div>

<script>
// Variables globales
let events = JSON.parse(localStorage.getItem('events') || '[]');
let hasChanges = false;
let selectedSearchIndex = -1;
let filteredEvents = [];
let timelineOffset = 0;
let currentEditingEventId = null;
let sidebarSelectedDate = null;

// Variables para drag/swipe
let isDragging = false;
let startX = 0;
let scrollStart = 0;
let dragDistance = 0;

// Marcar cambios
function markChanged() {
hasChanges = true;
document.getElementById('btnSave').classList.add('changed');
}

// Guardar calendario
document.getElementById('btnSave').addEventListener('click', function() {
localStorage.setItem('events', JSON.stringify(events));
hasChanges = false;
this.classList.remove('changed');
alert('Calendario guardado correctamente');
});

// Actualizar reloj
function updateClock() {
const now = new Date();
const hours = String(now.getHours()).padStart(2, '0');
const minutes = String(now.getMinutes()).padStart(2, '0');
const seconds = String(now.getSeconds()).padStart(2, '0');
document.getElementById('clock').textContent = `${hours}:${minutes}:${seconds}`;
}

// Actualizar fecha
function updateDate() {
const now = new Date();
const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
document.getElementById('dateDisplay').textContent = now.toLocaleDateString('es-ES', options);
}

// Calcular tiempo hasta hora objetivo
function getTimeUntil(targetHour, targetMinute) {
const now = new Date();
const target = new Date();
target.setHours(targetHour, targetMinute, 0, 0);

if (now > target) {
    target.setDate(target.getDate() + 1);
}

const diff = target - now;
const hours = Math.floor(diff / (1000 * 60 * 60));
const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
const seconds = Math.floor((diff % (1000 * 60)) / 1000);

return { hours, minutes, seconds, totalMs: diff };
}

// Actualizar MAÑANAS
function updateMorning() {
const now = new Date();
const day = now.getDay();
const hour = now.getHours();
const minute = now.getMinutes();

const isWeekday = day >= 1 && day <= 5;
const isActiveTime = hour >= 8 && (hour < 13 || (hour === 13 && minute < 30));

const title = document.getElementById('morningTitle');
const countdown = document.getElementById('morningCountdown');
const progressDiv = document.getElementById('morningProgress');

if (isWeekday && isActiveTime) {
    title.className = 'card-title neon-red';
    const timeUntil = getTimeUntil(13, 30);
    countdown.textContent = `${String(timeUntil.hours).padStart(2, '0')}:${String(timeUntil.minutes).padStart(2, '0')}:${String(timeUntil.seconds).padStart(2, '0')}`;
    
    const startTime = new Date();
    startTime.setHours(8, 30, 0, 0);
    const endTime = new Date();
    endTime.setHours(13, 30, 0, 0);
    
    const totalDuration = endTime - startTime;
    const elapsed = now - startTime;
    const progress = Math.max(0, Math.min(100, 100 - (elapsed / totalDuration * 100)));
    
    progressDiv.innerHTML = `<div class="progress-bar"><div class="progress-fill" style="width: ${progress}%"></div></div>`;
} else {
    title.className = 'card-title';
    title.style.color = 'white';
    const timeUntil = getTimeUntil(13, 30);
    countdown.textContent = `${String(timeUntil.hours).padStart(2, '0')}:${String(timeUntil.minutes).padStart(2, '0')}:${String(timeUntil.seconds).padStart(2, '0')}`;
    progressDiv.innerHTML = '';
}
}

// Actualizar TARDES
function updateAfternoon() {
const now = new Date();
const day = now.getDay();
const hour = now.getHours();
const minute = now.getMinutes();

const isActiveDay = day >= 1 && day <= 4;
const isActiveTime = hour >= 16 && (hour < 19 || (hour === 19 && minute < 30));

const title = document.getElementById('afternoonTitle');
const countdown = document.getElementById('afternoonCountdown');
const progressDiv = document.getElementById('afternoonProgress');

if (isActiveDay && isActiveTime) {
    title.className = 'card-title neon-red';
    const timeUntil = getTimeUntil(19, 30);
    countdown.textContent = `${String(timeUntil.hours).padStart(2, '0')}:${String(timeUntil.minutes).padStart(2, '0')}:${String(timeUntil.seconds).padStart(2, '0')}`;
    
    const startTime = new Date();
    startTime.setHours(16, 0, 0, 0);
    const endTime = new Date();
    endTime.setHours(19, 30, 0, 0);
    
    const totalDuration = endTime - startTime;
    const elapsed = now - startTime;
    const progress = Math.max(0, Math.min(100, 100 - (elapsed / totalDuration * 100)));
    
    progressDiv.innerHTML = `<div class="progress-bar"><div class="progress-fill" style="width: ${progress}%"></div></div>`;
} else {
    title.className = 'card-title';
    title.style.color = 'white';
    const timeUntil = getTimeUntil(19, 30);
    countdown.textContent = `${String(timeUntil.hours).padStart(2, '0')}:${String(timeUntil.minutes).padStart(2, '0')}:${String(timeUntil.seconds).padStart(2, '0')}`;
    progressDiv.innerHTML = '';
}
}

// Mover línea de tiempo
function moveTimeline(days) {
timelineOffset += days;
renderTimeline();
}

function resetTimeline() {
timelineOffset = 0;
renderTimeline();
}

// Drag & Swipe en timeline
const timelineDays = document.getElementById('timelineDays');

timelineDays.addEventListener('mousedown', startDrag);
timelineDays.addEventListener('touchstart', startDrag);

document.addEventListener('mousemove', drag);
document.addEventListener('touchmove', drag);

document.addEventListener('mouseup', endDrag);
document.addEventListener('touchend', endDrag);

function startDrag(e) {
isDragging = true;
startX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
dragDistance = 0;
timelineDays.classList.add('dragging');
}

function drag(e) {
if (!isDragging) return;
e.preventDefault();
const x = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
dragDistance = x - startX;
}

function endDrag(e) {
if (!isDragging) return;
isDragging = false;
timelineDays.classList.remove('dragging');
    
if (Math.abs(dragDistance) > 50) {
    if (dragDistance > 0) {
        moveTimeline(-1);
    } else {
        moveTimeline(1);
    }
}
dragDistance = 0;
}

// Renderizar línea de tiempo
function renderTimeline() {
const container = document.getElementById('timelineDays');
container.innerHTML = '';

const today = new Date();
today.setHours(0, 0, 0, 0);

for (let i = -2; i <= 2; i++) {
    const date = new Date(today);
    date.setDate(date.getDate() + i + timelineOffset);
    
    const dayDiv = document.createElement('div');
    dayDiv.className = 'timeline-day';
    
    const day = date.getDay();
    const isWeekend = day === 0 || day === 6;
    
    const compareDate = new Date(date);
    compareDate.setHours(0, 0, 0, 0);
    const compareToday = new Date(today);
    compareToday.setHours(0, 0, 0, 0);
    
    if (compareDate.getTime() === compareToday.getTime()) {
        dayDiv.classList.add('today');
    } else if (date > today) {
        dayDiv.classList.add('future');
    } else {
        dayDiv.classList.add('past');
    }
    
    if (isWeekend) {
        dayDiv.classList.add('weekend');
    }
    
    const dateStr = date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
    dayDiv.innerHTML = `<div class="timeline-date">${dateStr}</div><div class="timeline-events" id="events-${i}"></div>`;
    
    const dayEvents = getEventsForDate(date);
    const eventsDiv = dayDiv.querySelector('.timeline-events');
    
    dayEvents.forEach(event => {
        const eventDiv = document.createElement('div');
        eventDiv.className = 'timeline-event';
        eventDiv.onclick = () => openEditEventModal(event.id);
        
        const timeStr = event.allDay ? 'TODO EL DÍA' : `${event.timeStart}${event.timeEnd ? '-' + event.timeEnd : ''}`;
        eventDiv.innerHTML = `<div class="timeline-event-time">${timeStr}</div><div>${event.description}</div>`;
        eventsDiv.appendChild(eventDiv);
    });
    
    container.appendChild(dayDiv);
}
}

// Obtener eventos de una fecha
function getEventsForDate(date) {
const dateStr = formatDate(date);
return events.filter(e => e.date === dateStr);
}

// Formatear fecha
function formatDate(date) {
const year = date.getFullYear();
const month = String(date.getMonth() + 1).padStart(2, '0');
const day = String(date.getDate()).padStart(2, '0');
return `${year}/${month}/${day}`;
}

// Abrir modal para añadir evento
function openAddEventModal(prefilledDate = null) {
currentEditingEventId = null;
document.getElementById('modalEventHeader').textContent = 'Añadir Evento';
document.getElementById('btnSaveEvent').textContent = 'Añadir';
document.getElementById('btnDuplicateEvent').style.display = 'none';
document.getElementById('btnDeleteEvent').style.display = 'none';

const dateInput = document.getElementById('eventDate');
if (prefilledDate) {
    dateInput.value = prefilledDate;
} else {
    dateInput.value = formatDate(new Date()).replace(/\//g, '-');
}

document.getElementById('eventTimeStart').value = '';
document.getElementById('eventTimeEnd').value = '';
document.getElementById('eventDescription').value = '';

document.getElementById('modalEvent').classList.add('visible');
}

// Abrir modal desde calendario
function openAddEventModalFromCalendar() {
openAddEventModal();
}

// Abrir modal para editar evento
function openEditEventModal(eventId) {
const event = events.find(e => e.id === eventId);
if (!event) return;

currentEditingEventId = eventId;
document.getElementById('modalEventHeader').textContent = 'Editar Evento';
document.getElementById('btnSaveEvent').textContent = 'Guardar Cambios';
document.getElementById('btnDuplicateEvent').style.display = 'inline-block';
document.getElementById('btnDeleteEvent').style.display = 'inline-block';

document.getElementById('eventDate').value = event.date.replace(/\//g, '-');
document.getElementById('eventTimeStart').value = event.timeStart || '';
document.getElementById('eventTimeEnd').value = event.timeEnd || '';
document.getElementById('eventDescription').value = event.description;

document.getElementById('modalEvent').classList.add('visible');
}

// Añadir evento desde formulario
document.getElementById('btnAdd').addEventListener('click', () => openAddEventModal());

document.getElementById('eventForm').addEventListener('submit', (e) => {
e.preventDefault();

const date = document.getElementById('eventDate').value.replace(/-/g, '/');
const timeStart = document.getElementById('eventTimeStart').value;
const timeEnd = document.getElementById('eventTimeEnd').value;
const description = document.getElementById('eventDescription').value;

if (currentEditingEventId) {
    // Editar evento existente
    const event = events.find(e => e.id === currentEditingEventId);
    if (event) {
        event.date = date;
        event.allDay = !timeStart;
        event.timeStart = timeStart || '';
        event.timeEnd = timeEnd || '';
        event.description = description;
    }
} else {
    // Añadir nuevo evento
    const event = {
        id: Date.now(),
        date: date,
        allDay: !timeStart,
        timeStart: timeStart || '',
        timeEnd: timeEnd || '',
        description: description
    };
    events.push(event);
}

markChanged();
renderTimeline();
if (document.getElementById('calendarView').classList.contains('visible')) {
    openCalendarView();
}
if (sidebarSelectedDate) {
    showDayEvents(sidebarSelectedDate, getEventsForDate(sidebarSelectedDate));
}
closeModal('modalEvent');
document.getElementById('eventForm').reset();
});

// Duplicar evento
function duplicateEvent() {
if (!currentEditingEventId) return;

const event = events.find(e => e.id === currentEditingEventId);
if (!event) return;

const newEvent = {
    id: Date.now(),
    date: event.date,
    allDay: event.allDay,
    timeStart: event.timeStart,
    timeEnd: event.timeEnd,
    description: event.description + ' (copia)'
};

events.push(newEvent);
markChanged();
renderTimeline();
if (document.getElementById('calendarView').classList.contains('visible')) {
    openCalendarView();
}
if (sidebarSelectedDate) {
    showDayEvents(sidebarSelectedDate, getEventsForDate(sidebarSelectedDate));
}
closeModal('modalEvent');
}

// Eliminar evento
function deleteEvent() {
if (!currentEditingEventId) return;

if (confirm('¿Estás seguro de que quieres eliminar este evento?')) {
    events = events.filter(e => e.id !== currentEditingEventId);
    markChanged();
    renderTimeline();
    if (document.getElementById('calendarView').classList.contains('visible')) {
        openCalendarView();
    }
    if (sidebarSelectedDate) {
        showDayEvents(sidebarSelectedDate, getEventsForDate(sidebarSelectedDate));
    }
    closeModal('modalEvent');
}
}

// Modal añadir eventos desde texto
document.getElementById('btnAddText').addEventListener('click', () => {
document.getElementById('modalAddText').classList.add('visible');
document.getElementById('eventsSummary').innerHTML = '';
});

// Parsear eventos desde texto
function parseEventsText() {
const text = document.getElementById('eventsText').value;
const lines = text.split('\n').filter(line => line.trim());

const parsedEvents = [];

lines.forEach(line => {
    const match = line.match(/[█!]\s*(\d{4}\/\d{2}\/\d{2})\s+(___________|(\d{2}:\d{2})-(\d{2}:\d{2}))\s+(.+)/);
    
    if (match) {
        const date = match[1];
        const time = match[2];
        const description = match[5].trim();
        
        const event = {
            date: date,
            allDay: time === '___________',
            timeStart: '',
            timeEnd: '',
            description: description
        };
        
        if (!event.allDay && match[3] && match[4]) {
            event.timeStart = match[3];
            event.timeEnd = match[4];
        }
        
        parsedEvents.push(event);
    }
});

const summaryDiv = document.getElementById('eventsSummary');
summaryDiv.innerHTML = '<h3 style="margin-top: 20px;">Eventos a añadir:</h3>';

if (parsedEvents.length === 0) {
    summaryDiv.innerHTML += '<p>No se encontraron eventos válidos.</p>';
    return;
}

const summaryList = document.createElement('div');
summaryList.className = 'event-summary';

parsedEvents.forEach((event, index) => {
    const item = document.createElement('div');
    item.className = 'event-summary-item';
    const timeStr = event.allDay ? 'TODO EL DÍA' : `${event.timeStart}${event.timeEnd ? '-' + event.timeEnd : ''}`;
    item.innerHTML = `<strong>Fecha:</strong> ${event.date} | <strong>Hora:</strong> ${timeStr}<br><strong>Evento:</strong> ${event.description}`;
    summaryList.appendChild(item);
});

summaryDiv.appendChild(summaryList);

const buttonsDiv = document.createElement('div');
buttonsDiv.className = 'modal-buttons';
buttonsDiv.innerHTML = `
    <button class="btn btn-add" onclick='confirmAddEvents(${JSON.stringify(parsedEvents)})'>Confirmar y Añadir</button>
    <button class="btn" style="background: #666;" onclick="closeModal('modalAddText')">Cancelar</button>
`;
summaryDiv.appendChild(buttonsDiv);
}

// Confirmar y añadir eventos
function confirmAddEvents(parsedEvents) {
parsedEvents.forEach(event => {
    events.push({
        id: Date.now() + Math.random(),
        ...event
    });
});

markChanged();
renderTimeline();
closeModal('modalAddText');
document.getElementById('eventsText').value = '';
document.getElementById('eventsSummary').innerHTML = '';
}

// Cerrar modal
function closeModal(modalId) {
document.getElementById(modalId).classList.remove('visible');
}

// Búsqueda de eventos
const searchInput = document.getElementById('searchInput');
const clearSearch = document.getElementById('clearSearch');
const searchDropdown = document.getElementById('searchDropdown');

searchInput.addEventListener('input', function() {
const query = this.value.toLowerCase();

if (query.length > 0) {
    clearSearch.classList.add('visible');
    
    filteredEvents = events.filter(e => 
        e.description.toLowerCase().includes(query) ||
        e.date.includes(query)
    );
    
    if (filteredEvents.length > 0) {
        searchDropdown.innerHTML = '';
        filteredEvents.forEach((event, index) => {
            const item = document.createElement('div');
            item.className = 'search-item';
            const timeStr = event.allDay ? 'TODO EL DÍA' : `${event.timeStart}${event.timeEnd ? '-' + event.timeEnd : ''}`;
            item.innerHTML = `<strong>${event.date}</strong> ${timeStr}<br>${event.description}`;
            item.onclick = () => selectSearchItem(event.id);
            item.dataset.index = index;
            searchDropdown.appendChild(item);
        });
        searchDropdown.classList.add('visible');
        selectedSearchIndex = -1;
    } else {
        searchDropdown.innerHTML = '<div class="search-item">No se encontraron eventos</div>';
        searchDropdown.classList.add('visible');
    }
} else {
    clearSearch.classList.remove('visible');
    searchDropdown.classList.remove('visible');
}
});

clearSearch.addEventListener('click', function() {
searchInput.value = '';
clearSearch.classList.remove('visible');
searchDropdown.classList.remove('visible');
});

searchInput.addEventListener('keydown', function(e) {
const items = searchDropdown.querySelectorAll('.search-item');

if (e.key === 'ArrowDown') {
    e.preventDefault();
    selectedSearchIndex = Math.min(selectedSearchIndex + 1, items.length - 1);
    updateSearchSelection(items);
} else if (e.key === 'ArrowUp') {
    e.preventDefault();
    selectedSearchIndex = Math.max(selectedSearchIndex - 1, 0);
    updateSearchSelection(items);
} else if (e.key === 'Enter' && selectedSearchIndex >= 0) {
    e.preventDefault();
    if (filteredEvents[selectedSearchIndex]) {
        selectSearchItem(filteredEvents[selectedSearchIndex].id);
    }
} else if (e.key === 'Escape') {
    searchDropdown.classList.remove('visible');
}
});

function updateSearchSelection(items) {
items.forEach((item, index) => {
    if (index === selectedSearchIndex) {
        item.classList.add('selected');
        item.scrollIntoView({ block: 'nearest' });
    } else {
        item.classList.remove('selected');
    }
});
}

function selectSearchItem(eventId) {
openEditEventModal(eventId);
searchInput.value = '';
clearSearch.classList.remove('visible');
searchDropdown.classList.remove('visible');
}

document.addEventListener('click', function(e) {
if (!e.target.closest('.search-container')) {
    searchDropdown.classList.remove('visible');
}
});

// Vista calendario anual
document.getElementById('dateDisplay').addEventListener('click', openCalendarView);
document.getElementById('todayTitle').addEventListener('click', openCalendarView);

function openCalendarView() {
const calendarView = document.getElementById('calendarView');
const monthsContainer = document.getElementById('calendarMonths');

monthsContainer.innerHTML = '';

const year = new Date().getFullYear();
const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                   'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

for (let month = 0; month < 12; month++) {
    const monthDiv = document.createElement('div');
    monthDiv.className = 'calendar-month';
    
    monthDiv.innerHTML = `<div class="calendar-month-title">${monthNames[month]} ${year}</div>`;
    
    const gridDiv = document.createElement('div');
    gridDiv.className = 'calendar-grid';
    
    ['L', 'M', 'X', 'J', 'V', 'S', 'D'].forEach(day => {
        const header = document.createElement('div');
        header.className = 'calendar-day-header';
        header.textContent = day;
        gridDiv.appendChild(header);
    });
    
    const firstDay = new Date(year, month, 1);
    let firstDayOfWeek = firstDay.getDay();
    firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;
    
    for (let i = 0; i < firstDayOfWeek; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day other-month';
        gridDiv.appendChild(emptyDay);
    }
    
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day';
        
        const dayOfWeek = date.getDay();
        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
        
        if (date.getTime() === today.getTime()) {
            dayDiv.classList.add('today');
        } else if (date > today) {
            dayDiv.classList.add('future');
        } else {
            dayDiv.classList.add('past');
        }
        
        if (isWeekend) {
            dayDiv.classList.add('weekend');
        }
        
        dayDiv.innerHTML = `<div>${day}</div>`;
        
        const dayEvents = getEventsForDate(date);
        if (dayEvents.length > 0) {
            const dotsDiv = document.createElement('div');
            dotsDiv.className = 'calendar-day-dots';
            for (let i = 0; i < Math.min(dayEvents.length, 5); i++) {
                const dot = document.createElement('div');
                dot.className = 'calendar-day-dot';
                dotsDiv.appendChild(dot);
            }
            dayDiv.appendChild(dotsDiv);
        }
        
        dayDiv.onclick = () => showDayEvents(date, dayEvents);
        
        gridDiv.appendChild(dayDiv);
    }
    
    monthDiv.appendChild(gridDiv);
    monthsContainer.appendChild(monthDiv);
}

calendarView.classList.add('visible');
}

function closeCalendarView() {
document.getElementById('calendarView').classList.remove('visible');
closeSidebar();
}

function showDayEvents(date, dayEvents) {
sidebarSelectedDate = date;
const sidebar = document.getElementById('calendarSidebar');
const dateDiv = document.getElementById('sidebarDate');
const eventsDiv = document.getElementById('sidebarEvents');

dateDiv.textContent = date.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

eventsDiv.innerHTML = '';

if (dayEvents.length === 0) {
    eventsDiv.innerHTML = '<p>No hay eventos para este día</p>';
} else {
    dayEvents.forEach(event => {
        const eventDiv = document.createElement('div');
        eventDiv.className = 'sidebar-event';
        const timeStr = event.allDay ? 'TODO EL DÍA' : `${event.timeStart}${event.timeEnd ? '-' + event.timeEnd : ''}`;
        eventDiv.innerHTML = `<strong>${timeStr}</strong><br>${event.description}`;
        eventDiv.onclick = () => openEditEventModal(event.id);
        eventsDiv.appendChild(eventDiv);
    });
}

sidebar.classList.add('visible');
}

function addEventToSidebarDate() {
if (sidebarSelectedDate) {
    const dateStr = formatDate(sidebarSelectedDate).replace(/\//g, '-');
    openAddEventModal(dateStr);
}
}

function closeSidebar() {
document.getElementById('calendarSidebar').classList.remove('visible');
sidebarSelectedDate = null;
}

// Iframe navegación
const educaFrame = document.getElementById('educaFrame');
const iframeBack = document.getElementById('iframeBack');
const iframeForward = document.getElementById('iframeForward');
const iframeHome = document.getElementById('iframeHome');

let iframeHistory = ['https://www.educa.jcyl.es/profesorado/es/formacion-profesorado/actualidad-formacion-profesorado'];
let iframeHistoryIndex = 0;

iframeBack.addEventListener('click', () => {
if (iframeHistoryIndex > 0) {
    iframeHistoryIndex--;
    educaFrame.src = iframeHistory[iframeHistoryIndex];
    updateIframeButtons();
}
});

iframeForward.addEventListener('click', () => {
if (iframeHistoryIndex < iframeHistory.length - 1) {
    iframeHistoryIndex++;
    educaFrame.src = iframeHistory[iframeHistoryIndex];
    updateIframeButtons();
}
});

iframeHome.addEventListener('click', () => {
educaFrame.src = 'https://www.educa.jcyl.es/profesorado/es/formacion-profesorado/actualidad-formacion-profesorado';
iframeHistory.push(educaFrame.src);
iframeHistoryIndex = iframeHistory.length - 1;
updateIframeButtons();
});

function updateIframeButtons() {
iframeBack.disabled = iframeHistoryIndex <= 0;
iframeForward.disabled = iframeHistoryIndex >= iframeHistory.length - 1;
}

// Inicialización
setInterval(updateClock, 1000);
setInterval(updateMorning, 1000);
setInterval(updateAfternoon, 1000);
updateClock();
updateDate();
updateMorning();
updateAfternoon();
renderTimeline();

setInterval(renderTimeline, 60000);
</script>
</body>
</html>
